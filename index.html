<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OCM MVRV</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: #18181D;
      font-family: Inter, sans-serif;
      color: white;
    }
    #chart-container {
      position: relative;
      width: 100%;
      max-width: 900px;
      height: 640px;
      margin: auto;
      background-color: #18181D;
    }
    #logo-front {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.85;
      pointer-events: none;
      width: 70%;
      height: auto;
      z-index: 10;
      mix-blend-mode: lighten;
    }
    #chart {
      position: relative;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #smaSelector {
      text-align: center;
      margin: 12px 0;
    }
    select {
      background: #18181D;
      color: white;
      border: 1px solid #444;
      padding: 6px 12px;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <div id="smaSelector">
    <label for="smaDropdown">MVRV SMA:</label>
    <select id="smaDropdown">
      <option value="none">None</option>
      <option value="7">7-day</option>
      <option value="30">30-day</option>
      <option value="50">50-day</option>
      <option value="100">100-day</option>
      <option value="200">200-day</option>
      <option value="200">365-day</option>
    </select>
  </div>

  <div id="chart-container">
    <img id="logo-front" src="logo.png" alt="Logo Overlay" />
    <div id="chart"></div>
  </div>

  <script>
    function calculateSMA(data, windowSize) {
      const sma = [];
      for (let i = 0; i < data.length; i++) {
        if (i < windowSize - 1) {
          sma.push(null);
          continue;
        }
        const windowData = data.slice(i - windowSize + 1, i + 1);
        const avg = windowData.reduce((sum, d) => sum + d.mvrv, 0) / windowSize;
        sma.push(avg);
      }
      return sma;
    }

    let mvrvDataGlobal = [];

    function drawChart(selectedSMA = 'none') {
      Promise.all([
        fetch("/api/derived/price.js").then(r => r.json()),
        fetch("/api/market_value_to_realized_value.js").then(r => r.json())
      ])
      .then(([priceResult, mvrvResult]) => {
        const priceData = priceResult.data.filter(d => d.date >= '2013-01-01');
        const mvrvData = mvrvResult.data.filter(d => d.date >= '2013-01-01');
        mvrvDataGlobal = mvrvData;

        const priceTrace = {
          x: priceData.map(d => d.date),
          y: priceData.map(d => d.price),
          xaxis: 'x',
          yaxis: 'y1',
          type: 'scatter',
          mode: 'lines',
          name: 'BTC Price',
          line: { color: 'white', width: 2 },
          hoverinfo: 'skip',
          hovertemplate: '%{x|%Y-%m-%d}<br><b>Price:</b> $%{y:,.0f}<extra></extra>'
        };

        const mvrvTrace = {
          x: mvrvData.map(d => d.date),
          y: mvrvData.map(d => d.mvrv),
          xaxis: 'x',
          yaxis: 'y2',
          type: 'scatter',
          mode: 'lines',
          name: 'MVRV',
          line: { color: '#1F7120', width: 2 },
          hoverinfo: 'skip',
          hovertemplate: '%{x|%Y-%m-%d}<br><b>MVRV:</b> %{y:.3f}<extra></extra>'
        };

        const traces = [priceTrace, mvrvTrace];

        if (selectedSMA !== 'none') {
          const windowSize = parseInt(selectedSMA);
          const smaValues = calculateSMA(mvrvData, windowSize);

          const smaTrace = {
            x: mvrvData.map(d => d.date),
            y: smaValues,
            xaxis: 'x',
            yaxis: 'y2',
            type: 'scatter',
            mode: 'lines',
            name: `${windowSize}D SMA (MVRV)`,
            line: { color: '#FFD700', width: 2 },
            hovertemplate: '%{x|%Y-%m-%d}<br><b>SMA:</b> %{y:.3f}<extra></extra>'
          };

          traces.push(smaTrace);
        }

        const layout = {
          grid: { rows: 2, columns: 1, pattern: 'independent' },
          paper_bgcolor: '#18181D',
          plot_bgcolor: '#18181D',
          font: { color: 'white' },
          margin: { t: 30, b: 50 },
          hovermode: 'x unified',

          xaxis: {
            domain: [0, 1],
            showline: true,
            type: 'date',
            gridcolor: '#212127',
            showgrid: false,
            zerolinecolor: '#212127',
            showspikes: true,
            spikemode: 'across',
            spikesnap: 'cursor',
            spikethickness: 1,
            spikecolor: 'white',
            spikeDash: 'dash',
            rangeslider: {
              visible: true,
              bgcolor: "#18181D",
              bordercolor: "#333",
              thickness: 0.1
            }
          },

          yaxis: {
            domain: [0.53, 1],
            title: 'Price (USD)',
            type: 'log',
            gridcolor: '#212127',
            showgrid: false,
            zerolinecolor: '#212127',
            showspikes: true,
            spikemode: 'across',
            spikesnap: 'cursor',
            spikethickness: 1,
            spikecolor: 'white',
            spikeDash: 'dash',
            tickprefix: '$'
          },

          yaxis2: {
            domain: [0, 0.57],
            title: 'MVRV',
            gridcolor: '#212127',
            showgrid: false,
            zerolinecolor: '#212127',
            showspikes: true,
            spikemode: 'across',
            spikesnap: 'cursor',
            spikethickness: 1,
            spikecolor: 'white',
            spikeDash: 'dash'
          },

          legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.32 }
        };

        Plotly.newPlot('chart', traces, layout);
      })
      .catch(err => {
        console.error(err);
        document.getElementById('chart').innerHTML = `<p style="color:red; text-align:center;">Failed to load data.</p>`;
      });
    }

    // Initial render
    drawChart();

    // Dropdown listener
    document.getElementById('smaDropdown').addEventListener('change', e => {
      drawChart(e.target.value);
    });
  </script>
</body>
</html>
