<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      margin: 0;
      background-color: black;
    }

    #chart {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    #logo-front {
      position: absolute;
      top: 0;
      left: 0;
      height: 150px;
      z-index: 10;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div id="chart"></div>
  <img id="logo-front" src="logo.png" />

  <script>
    function getColorForMVRV(mvrv) {
      if (mvrv >= 2.5) return '#ff0000';
      else if (mvrv >= 2) return '#ff6600';
      else if (mvrv >= 1.5) return '#ffaa00';
      else if (mvrv >= 1) return '#aaff00';
      else if (mvrv >= 0.5) return '#00ffaa';
      else return '#00aaff';
    }

    async function fetchData() {
      const [priceResponse, mvrvResponse] = await Promise.all([
        fetch("https://raw.githubusercontent.com/OnChainMind/ocm_data/master/bitcoin_price.json"),
        fetch("https://raw.githubusercontent.com/OnChainMind/ocm_data/master/bitcoin_mvrv.json")
      ]);

      const priceData = await priceResponse.json();
      const mvrvData = await mvrvResponse.json();

      return { priceData, mvrvData };
    }

    function buildTraces(priceData, mvrvData) {
      const traces = [];

      // BTC price trace
      traces.push({
        x: priceData.map(d => d.date),
        y: priceData.map(d => d.price),
        type: 'scatter',
        mode: 'lines',
        name: 'BTC Price',
        line: { color: '#ffffff', width: 2 },
        yaxis: 'y1',
        hovertemplate: '%{x|%Y-%m-%d}<br><b>Price:</b> $%{y:.2f}<extra></extra>',
        visible: true
      });

      // MVRV gradient segments (no hover)
      for (let i = 1; i < mvrvData.length; i++) {
        const prev = mvrvData[i - 1];
        const curr = mvrvData[i];
        const color = getColorForMVRV(curr.mvrv);

        traces.push({
          x: [prev.date, curr.date],
          y: [prev.mvrv, curr.mvrv],
          yaxis: 'y2',
          type: 'scatter',
          mode: 'lines',
          line: { color: color, width: 2 },
          name: undefined,
          showlegend: false,
          hoverinfo: 'skip',
          legendgroup: 'mvrv',
          visible: true
        });
      }

      // Transparent MVRV hover trace (single tooltip + legend control)
      traces.push({
        x: mvrvData.map(d => d.date),
        y: mvrvData.map(d => d.mvrv),
        yaxis: 'y2',
        type: 'scatter',
        mode: 'markers',
        marker: { color: 'rgba(0,0,0,0)', size: 6 },
        hovertemplate: '%{x|%Y-%m-%d}<br><b>MVRV:</b> %{y:.3f}<extra></extra>',
        name: 'MVRV',
        showlegend: true,
        legendgroup: 'mvrv',
        visible: true
      });

      return traces;
    }

    function buildLayout() {
      return {
        paper_bgcolor: 'black',
        plot_bgcolor: 'black',
        font: { color: 'white' },
        legend: { orientation: "h", y: -0.2 },
        margin: { t: 40, l: 50, r: 50, b: 50 },
        xaxis: {
          domain: [0, 1],
          showgrid: false,
          tickformat: "%Y-%m-%d"
        },
        yaxis: {
          title: 'BTC Price (USD)',
          domain: [0.3, 1],
          type: 'log',
          showgrid: false
        },
        yaxis2: {
          title: 'MVRV',
          domain: [0, 0.25],
          overlaying: 'y',
          side: 'right',
          showgrid: false
        }
      };
    }

    fetchData().then(({ priceData, mvrvData }) => {
      const traces = buildTraces(priceData, mvrvData);
      const layout = buildLayout();

      Plotly.newPlot('chart', traces, layout, { responsive: true });

      // Hide logo-front on PNG download
      const logo = document.getElementById('logo-front');
      document.querySelector('.modebar-btn[data-title="Download plot as a png"]').addEventListener('click', () => {
        logo.style.display = 'none';
        setTimeout(() => logo.style.display = '', 1000);
      });
    }).catch(error => {
      console.error("Error loading or rendering data:", error);
      document.getElementById("chart").innerHTML = "<h2 style='color:white;'>Failed to load data.</h2>";
    });
  </script>
</body>
</html>
