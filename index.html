<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OCM MVRV</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    #chart {
      width: 100%;
      max-width: 900px;
      height: 640px;
      margin: auto;
      background-image: url('logo.png');
      background-repeat: no-repeat;
      background-position: center 20%;
      background-size: contain;
    }
    body {
      margin: 0;
      background-color: #18181D;
      font-family: Inter, sans-serif;
      color: white;
    }
  </style>
</head>
<body>
  <div id="chart"></div>
  <script>
    Promise.all([
      fetch("/api/derived/price.js").then(r => r.json()),
      fetch("/api/market_value_to_realized_value.js").then(r => r.json())
    ])
    .then(([priceResult, mvrvResult]) => {
      const priceData = priceResult.data.filter(d => d.date >= '2013-01-01');
      const mvrvData = mvrvResult.data.filter(d => d.date >= '2013-01-01');

const priceTrace = {
  x: priceData.map(d => d.date),
  y: priceData.map(d => d.price),
  xaxis: 'x',
  yaxis: 'y1',
  type: 'scatter',
  mode: 'lines',
  name: 'BTC Price',
  line: { color: 'white', width: 2 },
  hovertemplate: '%{x|%Y-%m-%d}<br><b>Price:</b> $%{y:,.0f}<extra></extra>'
};

const mvrvTrace = {
  x: mvrvData.map(d => d.date),
  y: mvrvData.map(d => d.mvrv),
  xaxis: 'x',
  yaxis: 'y2',
  type: 'scatter',
  mode: 'lines',
  name: 'MVRV',
  line: { color: '#1F7120', width: 2 },
  hovertemplate: '%{x|%Y-%m-%d}<br><b>MVRV:</b> %{y:.3f}<extra></extra>'
};

        const layout = {
  grid: { rows: 2, columns: 1, pattern: 'independent' },
  paper_bgcolor: '#18181D',
  plot_bgcolor: '#18181D',
  font: { color: 'white' },
  margin: { t: 30, b: 50 },
  hovermode: 'x unified',

  xaxis: {
    domain: [0, 1],
    showline: true,
    type: 'date',
    gridcolor: '#212127',
    zerolinecolor: '#212127',
    showspikes: true,
    spikemode: 'across',
    spikesnap: 'cursor',
    spikethickness: 1,
    spikecolor: 'white',
    spikeDash: 'dash',
    rangeslider: {
      visible: true,
      bgcolor: "#18181D",
      bordercolor: "#333",
      thickness: 0.1
    }
  },

  yaxis: {
    domain: [0.53, 1],
    title: 'Price (Log Scale)',
    type: 'log',
    gridcolor: '#212127',
    zerolinecolor: '#212127',
    showspikes: true,
    spikemode: 'across',
    spikesnap: 'cursor',
    spikethickness: 1,
    spikecolor: 'white',
    spikeDash: 'dash'
  },

  yaxis2: {
    domain: [0, 0.57],
    title: 'MVRV',
    gridcolor: '#212127',
    zerolinecolor: '#212127',
    showspikes: true,
    spikemode: 'across',
    spikesnap: 'cursor',
    spikethickness: 1,
    spikecolor: 'white',
    spikeDash: 'dash'
  },

  images: [
  {
    source: "logo.png",        // Same path
    xref: "paper",
    yref: "paper",
    x: 0.5,
    y: 0.77,                    // Centered vertically across both charts
    sizex: 0.6,                // Slightly smaller to prevent clipping
    sizey: 0.6,
    xanchor: "center",
    yanchor: "middle",
    opacity: 0.18,
    layer: "below"
  }
],

  legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.32 }
};

      Plotly.newPlot('chart', [priceTrace, mvrvTrace], layout);
    })
    .catch(err => {
      console.error(err);
      document.getElementById('chart').innerHTML = `<p style="color:red; text-align:center;">Failed to load data.</p>`;
    });
  </script>
</body>
</html>
