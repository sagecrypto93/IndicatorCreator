<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OCM MVRV</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* … your existing styles … */
  </style>
</head>
<body>
  <div id="controls">
    <label for="smaSelect">MVRV SMA: </label>
    <select id="smaSelect">
      <option value="none">None</option>
      <option value="7">7‑day</option>
      <option value="30">30‑day</option>
      <option value="50">50‑day</option>
      <option value="100">100‑day</option>
      <option value="200">200‑day</option>
      <option value="365" selected>365‑day</option>
    </select>
  </div>

  <div id="chart-container">
    <img id="logo-front" src="logo.png" alt="Logo Overlay" />
    <div id="chart"></div>
  </div>

  <script>
    const mvrvColors = [/* … your color array … */];

    function getColorForMVRV(val) {
      const min = 0.7, max = 3.0;
      const clamped = Math.max(min, Math.min(max, val));
      return mvrvColors[Math.floor((clamped - min) / (max - min) * (mvrvColors.length - 1))];
    }

    function calculateStats(values) {
      const n = values.length;
      const mean = values.reduce((a, b) => a + b, 0) / n;
      const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / n;
      return { mean, std: Math.sqrt(variance) };
    }

    function calculateSMA(values, period) {
      const sma = new Array(values.length).fill(null);
      let sum = 0;
      for (let i = 0; i < values.length; i++) {
        sum += values[i];
        if (i >= period) sum -= values[i - period];
        if (i >= period - 1) sma[i] = sum / period;
      }
      return sma;
    }

    function buildStaticTraces(priceDates, priceValues, dates, mvrvValues, stats) {
      const { mean, std } = stats;
      const plus1 = new Array(mvrvValues.length).fill(mean + std);
      const plus2 = new Array(mvrvValues.length).fill(mean + 2 * std);
      const minus1 = new Array(mvrvValues.length).fill(mean - std);
      const minus2 = new Array(mvrvValues.length).fill(mean - 2 * std);

      const traces = [
        {
          x: priceDates,
          y: priceValues,
          yaxis: 'y1',
          type: 'scatter',
          mode: 'lines',
          name: 'BTC Price',
          line: { color: 'white', width: 2 },
          hovertemplate: '%{x|%Y‑%m‑%d}<br><b>Price:</b> $%{y:,.0f}<extra></extra>'
        },
        // Combine gradient segments into fewer traces: here we just draw all points with markers hidden
        {
          x: dates,
          y: mvrvValues,
          yaxis: 'y2',
          type: 'scatter',
          mode: 'lines',
          line: { color: 'rgba(0,0,0,0)', width: 0 },
          visible: false
        },
        {
          x: dates, y: plus1,
          yaxis: 'y2', type: 'scatter', mode: 'lines',
          name: '+1σ', line: { color: 'orange', width: 1.5, dash: 'dot' },
          legendgroup: 'stddev', hoverinfo: 'skip'
        },
        {
          x: dates, y: plus2,
          yaxis: 'y2', type: 'scatter', mode: 'lines',
          name: '+2σ', line: { color: 'red', width: 1.5, dash: 'dot' },
          legendgroup: 'stddev', hoverinfo: 'skip'
        },
        {
          x: dates, y: minus1,
          yaxis: 'y2', type: 'scatter', mode: 'lines',
          name: '-1σ', line: { color: 'orange', width: 1.5, dash: 'dot' },
          legendgroup: 'stddev', hoverinfo: 'skip'
        },
        {
          x: dates, y: minus2,
          yaxis: 'y2', type: 'scatter', mode: 'lines',
          name: '-2σ', line: { color: 'red', width: 1.5, dash: 'dot' },
          legendgroup: 'stddev', hoverinfo: 'skip'
        },
        {
          x: dates, y: mvrvValues,
          yaxis: 'y2',
          type: 'scatter',
          mode: 'markers',
          marker: { color: 'rgba(0,0,0,0)', size: 6 },
          hovertemplate: '%{x|%Y‑%m‑%d}<br><b>MVRV:</b> %{y:.3f}<extra></extra>',
          name: 'MVRV',
          showlegend: true,
          legendgroup: 'mvrv'
        }
      ];
      return traces;
    }

    function buildDynamicTraces(dates, mvrvValues, smaPeriod) {
      if (smaPeriod === 'none') return [];
      const period = parseInt(smaPeriod);
      const sma = calculateSMA(mvrvValues, period);
      return [{
        x: dates, y: sma,
        yaxis: 'y2',
        type: 'scatter',
        mode: 'lines',
        name: `${period}-day SMA`,
        line: { color: 'white', width: 1.5, dash: 'dot' }
      }];
    }

    Promise.all([
      fetch("/api/derived/price.js").then(r => r.json()),
      fetch("/api/market_value_to_realized_value.js").then(r => r.json())
    ]).then(([priceResult, mvrvResult]) => {
      const cutoff = new Date('2013-02-01');
      const priceData = priceResult.data.filter(d => new Date(d.date) >= cutoff);
      const mvrvData = mvrvResult.data.filter(d => new Date(d.date) >= cutoff);

      const priceDates = priceData.map(d => d.date);
      const priceValues = priceData.map(d => d.price);
      const dates = mvrvData.map(d => d.date);
      const mvrvValues = mvrvData.map(d => d.mvrv);

      const stats = calculateStats(mvrvValues);
      const staticTraces = buildStaticTraces(priceDates, priceValues, dates, mvrvValues, stats);

      const layout = {
        grid: { rows: 2, columns: 1, pattern: 'independent' },
        paper_bgcolor: '#18181D', plot_bgcolor: '#18181D',
        font: { color: 'white' },
        margin: { t: 30, b: 50 },
        hovermode: 'x unified',
        xaxis: {
          domain: [0, 1], type: 'date',
          showspikes: true, spikemode: 'across',
          spikecolor: 'white', spikethickness: 1,
          range: ['2013-02-01', null],
          anchor: 'y2',
          showline: true, ticks: 'outside', ticklen: 6
        },
        yaxis: {
          domain: [0.50, 1], title: 'Price (USD)',
          type: 'log', tickprefix: '$',
          showticklabels: true, showline: false, ticks: ''
        },
        yaxis2: {
          domain: [0, 0.50], title: 'MVRV',
          showticklabels: true
        },
        legend: {
          orientation: 'h', x: 0.5, xanchor: 'center', y: -0.1
        }
      };

      function render(period) {
        const dyn = buildDynamicTraces(dates, mvrvValues, period);
        const all = staticTraces.concat(dyn);
        Plotly.react('chart', all, layout, { responsive: true });
      }

      render('365');

      // Download button
      Plotly.react('chart', staticTraces, layout, { responsive: true }).then(() => {
        const logo = document.getElementById('logo-front');
        const btn = document.querySelector('.modebar-btn[data-title="Download plot as a png"]');
        if (btn) btn.addEventListener('click', () => {
          logo.style.display = 'none';
          Plotly.downloadImage('chart',{ format:'png', width:1600, height:900, filename:'OCM-MVRV' })
            .finally(() => { logo.style.display = ''; });
        });
      });

      document.getElementById("smaSelect").addEventListener("change", e => {
        render(e.target.value);
      });
    }).catch(err => {
      console.error(err);
      document.getElementById('chart').innerHTML = `<p style="color:red;text-align:center;">Failed to load data.</p>`;
    });

  </script>
</body>
</html>
