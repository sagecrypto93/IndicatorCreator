<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div>
    <label for="smaSelect">SMA:</label>
    <select id="smaSelect">
      <option value="none">None</option>
      <option value="7">7-day SMA</option>
      <option value="30">30-day SMA</option>
      <option value="50">50-day SMA</option>
      <option value="100">100-day SMA</option>
      <option value="200">200-day SMA</option>
      <option value="365" selected>365-day SMA</option>
    </select>

    <label for="emaSelect">EMA:</label>
    <select id="emaSelect">
      <option value="none">None</option>
      <option value="7">7-day EMA</option>
      <option value="30">30-day EMA</option>
      <option value="50">50-day EMA</option>
      <option value="100">100-day EMA</option>
      <option value="200">200-day EMA</option>
      <option value="365">365-day EMA</option>
    </select>
  </div>

  <div id="chart"></div>

  <script>
    // === Example Data ===
    const btcData = [...Array(100)].map((_, i) => ({
      date: new Date(2022, 0, i + 1),
      price: 30000 + 5000 * Math.sin(i / 10)
    }));

    const mvrvData = btcData.map((d, i) => ({
      date: d.date,
      value: 1.5 + 0.3 * Math.sin(i / 15),
      plus1: 2,
      plus2: 2.5,
      minus1: 1,
      minus2: 0.8
    }));

    // === Moving Average Functions ===
    function calculateSMA(data, period) {
      const sma = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          sma.push(null);
        } else {
          const slice = data.slice(i - period + 1, i + 1);
          const avg = slice.reduce((acc, val) => acc + val, 0) / period;
          sma.push(avg);
        }
      }
      return sma;
    }

    function calculateEMA(data, period) {
      const ema = [];
      const k = 2 / (period + 1);
      let prev;
      for (let i = 0; i < data.length; i++) {
        const val = data[i];
        if (val == null) {
          ema.push(null);
          continue;
        }
        if (prev == null) {
          ema.push(val);
          prev = val;
        } else {
          const next = val * k + prev * (1 - k);
          ema.push(next);
          prev = next;
        }
      }
      return ema;
    }

    // === Build Traces ===
    function buildTraces(smaPeriod, emaPeriod) {
      const price = btcData.map(d => d.price);
      const traces = [];

      // BTC Price Trace
      traces.push({
        x: btcData.map(d => d.date),
        y: price,
        name: "BTC Price",
        type: "scatter",
        mode: "lines",
        line: { color: "#1f77b4" },
        yaxis: "y1"
      });

      // SMA Line
      if (smaPeriod !== "none") {
        const sma = calculateSMA(price, Number(smaPeriod));
        traces.push({
          x: btcData.map(d => d.date),
          y: sma,
          name: `${smaPeriod}-day SMA`,
          type: "scatter",
          mode: "lines",
          line: { color: "green", width: 1.5, dash: "dot" },
          yaxis: "y1"
        });
      }

      // EMA Line
      if (emaPeriod !== "none") {
        const ema = calculateEMA(price, Number(emaPeriod));
        traces.push({
          x: btcData.map(d => d.date),
          y: ema,
          name: `${emaPeriod}-day EMA`,
          type: "scatter",
          mode: "lines",
          line: { color: "orange", width: 1.5, dash: "dash" },
          yaxis: "y1"
        });
      }

      // MVRV Main Trace
      traces.push({
        x: mvrvData.map(d => d.date),
        y: mvrvData.map(d => d.value),
        name: "MVRV",
        type: "scatter",
        mode: "lines",
        line: { color: "#ff7f0e" },
        yaxis: "y2"
      });

      // StdDev Lines (with hover disabled)
      ["plus1", "plus2", "minus1", "minus2"].forEach((key, i) => {
        const label = key.includes("plus") ? `+${i + 1}σ` : `-${i - 1}σ`;
        const color = key.includes("plus") ? "orange" : "blue";
        traces.push({
          x: mvrvData.map(d => d.date),
          y: mvrvData.map(d => d[key]),
          name: label,
          type: "scatter",
          mode: "lines",
          line: { color, width: 1.5, dash: "dot" },
          yaxis: "y2",
          hoverinfo: "skip",
          showlegend: true
        });
      });

      return traces;
    }

    function renderChart() {
      const smaPeriod = document.getElementById("smaSelect").value;
      const emaPeriod = document.getElementById("emaSelect").value;
      const traces = buildTraces(smaPeriod, emaPeriod);

      Plotly.newPlot("chart", traces, {
        margin: { t: 50, b: 40 },
        hovermode: "x unified",
        xaxis: {
          domain: [0, 1],
          anchor: "y2",
          showgrid: false,
          showticklabels: true,
          title: "Date"
        },
        yaxis: {
          domain: [0.45, 1],
          title: "BTC Price",
          tickprefix: "$",
          fixedrange: false
        },
        yaxis2: {
          domain: [0, 0.4],
          title: "MVRV",
          fixedrange: false
        },
        legend: { orientation: "h", y: 1.1 },
        height: 600
      });
    }

    // Initial render
    renderChart();

    document.getElementById("smaSelect").addEventListener("change", renderChart);
    document.getElementById("emaSelect").addEventListener("change", renderChart);
  </script>
</body>
</html>
