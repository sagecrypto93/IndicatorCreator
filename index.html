<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MVRV Gradient Chart</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2>MVRV Z-Score Chart</h2>
  <div id="chart" style="width: 100%; height: 600px;"></div>

  <script>
    // Fetch your data (example async function)
    async function fetchData() {
      const [priceResp, mvrvResp] = await Promise.all([
        fetch('price.json'),
        fetch('mvrv.json')
      ]);
      const priceData = await priceResp.json();
      const mvrvData = await mvrvResp.json();
      return { priceData, mvrvData };
    }

    // Function to determine color based on MVRV value
    function getColorForMVRV(mvrv) {
      if (mvrv < 0) return "#4575b4";        // Deep blue
      else if (mvrv < 1) return "#91bfdb";   // Light blue
      else if (mvrv < 2) return "#e0f3f8";   // Pale blue
      else if (mvrv < 3) return "#fee090";   // Yellow
      else if (mvrv < 4) return "#fc8d59";   // Orange
      else return "#d73027";                 // Red
    }

    // Function to build Plotly traces
    function buildTraces(priceData, mvrvData) {
      const traces = [];

      // 1. BTC Price trace
      traces.push({
        x: priceData.map(d => d.date),
        y: priceData.map(d => d.price),
        type: 'scatter',
        mode: 'lines',
        name: 'BTC Price',
        line: { color: '#F2A900', width: 2 },
        yaxis: 'y',
        hovertemplate: '%{x|%Y-%m-%d}<br><b>BTC Price:</b> %{y:$,.0f}<extra></extra>'
      });

      // 2. MVRV gradient segments
      for (let i = 1; i < mvrvData.length; i++) {
        const prev = mvrvData[i - 1];
        const curr = mvrvData[i];
        const color = getColorForMVRV(curr.mvrv);

        traces.push({
          x: [prev.date, curr.date],
          y: [prev.mvrv, curr.mvrv],
          yaxis: 'y2',
          type: 'scatter',
          mode: 'lines',
          line: { color: color, width: 2 },
          name: undefined,
          showlegend: false,
          hoverinfo: 'skip'
        });
      }

      // 3. MVRV transparent marker hover trace
      traces.push({
        x: mvrvData.map(d => d.date),
        y: mvrvData.map(d => d.mvrv),
        yaxis: 'y2',
        type: 'scatter',
        mode: 'markers',
        marker: { color: 'rgba(0,0,0,0)', size: 8 },
        hovertemplate: '%{x|%Y-%m-%d}<br><b>MVRV:</b> %{y:.3f}<extra></extra>',
        name: 'MVRV',
        showlegend: true
      });

      return traces;
    }

    // Main function to render chart
    async function renderChart() {
      try {
        const { priceData, mvrvData } = await fetchData();
        const traces = buildTraces(priceData, mvrvData);

        const layout = {
          title: 'BTC Price and MVRV Z-Score',
          legend: { orientation: 'h', y: -0.2 },
          margin: { t: 50 },
          yaxis: {
            title: 'BTC Price (USD)',
            side: 'left',
            showgrid: false,
            zeroline: false,
            tickformat: '$,.0f'
          },
          yaxis2: {
            title: 'MVRV Z-Score',
            side: 'right',
            overlaying: 'y',
            showgrid: false,
            zeroline: false
          },
          xaxis: {
            title: 'Date',
            type: 'date',
            showgrid: false
          }
        };

        Plotly.newPlot('chart', traces, layout, { responsive: true });
      } catch (error) {
        console.error("Failed to load data or render chart:", error);
      }
    }

    renderChart();
  </script>
</body>
</html>
